{"version":3,"file":"HeftCommandLineParser.js","sourceRoot":"","sources":["../../src/cli/HeftCommandLineParser.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport {\n  CommandLineParser,\n  CommandLineStringListParameter,\n  CommandLineFlagParameter\n} from '@rushstack/ts-command-line';\nimport {\n  ITerminal,\n  Terminal,\n  InternalError,\n  ConsoleTerminalProvider,\n  AlreadyReportedError,\n  Path,\n  FileSystem\n} from '@rushstack/node-core-library';\nimport { ArgumentParser } from 'argparse';\nimport { SyncHook } from 'tapable';\n\nimport { MetricsCollector } from '../metrics/MetricsCollector';\nimport { CleanAction } from './actions/CleanAction';\nimport { BuildAction } from './actions/BuildAction';\nimport { StartAction } from './actions/StartAction';\nimport { TestAction } from './actions/TestAction';\nimport { PluginManager } from '../pluginFramework/PluginManager';\nimport { HeftConfiguration } from '../configuration/HeftConfiguration';\nimport { IHeftActionBaseOptions, IStages } from './actions/HeftActionBase';\nimport { InternalHeftSession } from '../pluginFramework/InternalHeftSession';\nimport { CleanStage } from '../stages/CleanStage';\nimport { BuildStage } from '../stages/BuildStage';\nimport { TestStage } from '../stages/TestStage';\nimport { LoggingManager } from '../pluginFramework/logging/LoggingManager';\nimport { ICustomActionOptions, CustomAction } from './actions/CustomAction';\nimport { Constants } from '../utilities/Constants';\nimport { IHeftLifecycle, HeftLifecycleHooks } from '../pluginFramework/HeftLifecycle';\nimport { HeftCommandLine } from './HeftCommandLine';\n\n/**\n * This interfaces specifies values for parameters that must be parsed before the CLI\n * is fully initialized.\n */\ninterface IPreInitializationArgumentValues {\n  plugins?: string[];\n  debug?: boolean;\n}\n\nexport class HeftCommandLineParser extends CommandLineParser {\n  private _terminalProvider: ConsoleTerminalProvider;\n  private _terminal: ITerminal;\n  private _loggingManager: LoggingManager;\n  private _metricsCollector: MetricsCollector;\n  private _pluginManager: PluginManager;\n  private _heftConfiguration: HeftConfiguration;\n  private _internalHeftSession: InternalHeftSession;\n  private _heftLifecycleHook: SyncHook<IHeftLifecycle>;\n\n  private _preInitializationArgumentValues: IPreInitializationArgumentValues;\n\n  private _unmanagedFlag!: CommandLineFlagParameter;\n  private _debugFlag!: CommandLineFlagParameter;\n  private _pluginsParameter!: CommandLineStringListParameter;\n\n  public get isDebug(): boolean {\n    return !!this._preInitializationArgumentValues.debug;\n  }\n\n  public get terminal(): ITerminal {\n    return this._terminal;\n  }\n\n  public constructor() {\n    super({\n      toolFilename: 'heft',\n      toolDescription: 'Heft is a pluggable build system designed for web projects.'\n    });\n\n    this._preInitializationArgumentValues = this._getPreInitializationArgumentValues();\n\n    this._terminalProvider = new ConsoleTerminalProvider();\n    this._terminal = new Terminal(this._terminalProvider);\n    this._metricsCollector = new MetricsCollector();\n    this._loggingManager = new LoggingManager({\n      terminalProvider: this._terminalProvider\n    });\n\n    if (this.isDebug) {\n      this._loggingManager.enablePrintStacks();\n      InternalError.breakInDebugger = true;\n    }\n\n    this._heftConfiguration = HeftConfiguration.initialize({\n      cwd: process.cwd(),\n      terminalProvider: this._terminalProvider\n    });\n\n    const stages: IStages = {\n      buildStage: new BuildStage(this._heftConfiguration, this._loggingManager),\n      cleanStage: new CleanStage(this._heftConfiguration, this._loggingManager),\n      testStage: new TestStage(this._heftConfiguration, this._loggingManager)\n    };\n\n    const actionOptions: IHeftActionBaseOptions = {\n      terminal: this._terminal,\n      loggingManager: this._loggingManager,\n      metricsCollector: this._metricsCollector,\n      heftConfiguration: this._heftConfiguration,\n      stages\n    };\n\n    this._heftLifecycleHook = new SyncHook<IHeftLifecycle>(['heftLifecycle']);\n    this._internalHeftSession = new InternalHeftSession({\n      getIsDebugMode: () => this.isDebug,\n      ...stages,\n      heftLifecycleHook: this._heftLifecycleHook,\n      loggingManager: this._loggingManager,\n      metricsCollector: this._metricsCollector,\n      registerAction: <TParameters>(options: ICustomActionOptions<TParameters>) => {\n        const action: CustomAction<TParameters> = new CustomAction(options, actionOptions);\n        this.addAction(action);\n      },\n      commandLine: new HeftCommandLine(this, this._terminal)\n    });\n\n    this._pluginManager = new PluginManager({\n      terminal: this._terminal,\n      heftConfiguration: this._heftConfiguration,\n      internalHeftSession: this._internalHeftSession\n    });\n\n    const cleanAction: CleanAction = new CleanAction(actionOptions);\n    const buildAction: BuildAction = new BuildAction(actionOptions);\n    const startAction: StartAction = new StartAction(actionOptions);\n    const testAction: TestAction = new TestAction(actionOptions);\n\n    this.addAction(cleanAction);\n    this.addAction(buildAction);\n    this.addAction(startAction);\n    this.addAction(testAction);\n  }\n\n  protected onDefineParameters(): void {\n    this._unmanagedFlag = this.defineFlagParameter({\n      parameterLongName: '--unmanaged',\n      description:\n        'Disables the Heft version selector: When Heft is invoked via the shell path, normally it' +\n        \" will examine the project's package.json dependencies and try to use the locally installed version\" +\n        ' of Heft. Specify \"--unmanaged\" to force the invoked version of Heft to be used. This is useful for' +\n        ' example if you want to test a different version of Heft.'\n    });\n\n    this._debugFlag = this.defineFlagParameter({\n      parameterLongName: Constants.debugParameterLongName,\n      description: 'Show the full call stack if an error occurs while executing the tool'\n    });\n\n    this._pluginsParameter = this.defineStringListParameter({\n      parameterLongName: Constants.pluginParameterLongName,\n      argumentName: 'PATH',\n      description: 'Used to specify Heft plugins.'\n    });\n  }\n\n  public async execute(args?: string[]): Promise<boolean> {\n    // Defensively set the exit code to 1 so if the tool crashes for whatever reason, we'll have a nonzero exit code.\n    process.exitCode = 1;\n\n    this._terminalProvider.verboseEnabled = this.isDebug;\n\n    try {\n      this._normalizeCwd();\n\n      await this._checkForUpgradeAsync();\n\n      await this._heftConfiguration._checkForRigAsync();\n\n      if (this._heftConfiguration.rigConfig.rigFound) {\n        const rigProfileFolder: string =\n          await this._heftConfiguration.rigConfig.getResolvedProfileFolderAsync();\n        const relativeRigFolderPath: string = Path.formatConcisely({\n          pathToConvert: rigProfileFolder,\n          baseFolder: this._heftConfiguration.buildFolder\n        });\n        this._terminal.writeLine(`Using rig configuration from ${relativeRigFolderPath}`);\n      }\n\n      await this._initializePluginsAsync();\n\n      const heftLifecycle: IHeftLifecycle = {\n        hooks: new HeftLifecycleHooks()\n      };\n      this._heftLifecycleHook.call(heftLifecycle);\n\n      await heftLifecycle.hooks.toolStart.promise();\n\n      return await super.execute(args);\n    } catch (e) {\n      await this._reportErrorAndSetExitCode(e as Error);\n      return false;\n    }\n  }\n\n  private async _checkForUpgradeAsync(): Promise<void> {\n    // The .heft/clean.json file is a fairly reliable heuristic for detecting projects created prior to\n    // the big config file redesign with Heft 0.14.0\n    if (await FileSystem.existsAsync('.heft/clean.json')) {\n      this._terminal.writeErrorLine(\n        '\\nThis project has a \".heft/clean.json\" file, which is now obsolete as of Heft 0.14.0.'\n      );\n      this._terminal.writeLine(\n        '\\nFor instructions for migrating config files, please read UPGRADING.md in the @rushstack/heft package folder.\\n'\n      );\n      throw new AlreadyReportedError();\n    }\n  }\n\n  protected async onExecute(): Promise<void> {\n    try {\n      await super.onExecute();\n      await this._metricsCollector.flushAndTeardownAsync();\n    } catch (e) {\n      await this._reportErrorAndSetExitCode(e as Error);\n    }\n\n    // If we make it here, things are fine and reset the exit code back to 0\n    process.exitCode = 0;\n  }\n\n  private _normalizeCwd(): void {\n    const buildFolder: string = this._heftConfiguration.buildFolder;\n    this._terminal.writeLine(`Project build folder is \"${buildFolder}\"`);\n    const currentCwd: string = process.cwd();\n    if (currentCwd !== buildFolder) {\n      // Update the CWD to the project's build root. Some tools, like Jest, use process.cwd()\n      this._terminal.writeVerboseLine(`CWD is \"${currentCwd}\". Normalizing to project build folder.`);\n      // If `process.cwd()` and `buildFolder` differ only by casing on Windows, the chdir operation will not fix the casing, which is the entire purpose of the exercise.\n      // As such, chdir to a different directory first. That directory needs to exist, so use the parent of the current directory.\n      // This will not work if the current folder is the drive root, but that is a rather exotic case.\n      process.chdir(__dirname);\n      process.chdir(buildFolder);\n    }\n  }\n\n  private _getPreInitializationArgumentValues(\n    args: string[] = process.argv\n  ): IPreInitializationArgumentValues {\n    // This is a rough parsing of the --plugin parameters\n    const parser: ArgumentParser = new ArgumentParser({ addHelp: false });\n    parser.addArgument(this._pluginsParameter.longName, { dest: 'plugins', action: 'append' });\n    parser.addArgument(this._debugFlag.longName, { dest: 'debug', action: 'storeTrue' });\n\n    const [result]: IPreInitializationArgumentValues[] = parser.parseKnownArgs(args);\n    return result;\n  }\n\n  private async _initializePluginsAsync(): Promise<void> {\n    this._pluginManager.initializeDefaultPlugins();\n\n    await this._pluginManager.initializePluginsFromConfigFileAsync();\n\n    const pluginSpecifiers: string[] = this._preInitializationArgumentValues.plugins || [];\n    for (const pluginSpecifier of pluginSpecifiers) {\n      this._pluginManager.initializePlugin(pluginSpecifier);\n    }\n\n    this._pluginManager.afterInitializeAllPlugins();\n  }\n\n  private async _reportErrorAndSetExitCode(error: Error): Promise<void> {\n    if (!(error instanceof AlreadyReportedError)) {\n      this._terminal.writeErrorLine(error.toString());\n    }\n\n    if (this.isDebug) {\n      this._terminal.writeLine();\n      this._terminal.writeErrorLine(error.stack!);\n    }\n\n    await this._metricsCollector.flushAndTeardownAsync();\n\n    if (!process.exitCode || process.exitCode > 0) {\n      process.exit(process.exitCode);\n    } else {\n      process.exit(1);\n    }\n  }\n}\n"]}