{"version":3,"file":"BuildAction.js","sourceRoot":"","sources":["../../../src/cli/actions/BuildAction.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;AAI3D,qDAA0E;AAE1E,qDAAkD;AAClD,wDAAwG;AAExG,MAAa,WAAY,SAAQ,+BAAc;IAO7C,YACE,iBAAyC,EACzC,2BAAsD;QACpD,UAAU,EAAE,OAAO;QACnB,OAAO,EAAE,oBAAoB;QAC7B,aAAa,EAAE,EAAE;KAClB;QAED,KAAK,CAAC,wBAAwB,EAAE,iBAAiB,CAAC,CAAC;IACrD,CAAC;IAEM,kBAAkB;QACvB,KAAK,CAAC,kBAAkB,EAAE,CAAC;QAE3B,IAAI,CAAC,wBAAwB,GAAG,uBAAU,CAAC,6BAA6B,CAAC,IAAI,CAAC,CAAC;QAC/E,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,wBAAwB,CAAC,cAAc,CAAC;QACpE,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,wBAAwB,CAAC,QAAQ,CAAC;QAExD,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,mBAAmB,CAAC;YACzC,iBAAiB,EAAE,SAAS;YAC5B,kBAAkB,EAAE,IAAI;YACxB,WAAW,EAAE,uCAAuC;SACrD,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,mBAAmB,CAAC;YACzC,iBAAiB,EAAE,SAAS;YAC5B,WAAW,EAAE,kDAAkD;SAChE,CAAC,CAAC;IACL,CAAC;IAES,KAAK,CAAC,kBAAkB;QAChC,MAAM,IAAI,CAAC,wBAAwB,EAAE,CAAC;QACtC,MAAM,IAAI,CAAC,aAAa,EAAE,CAAC;IAC7B,CAAC;IAES,KAAK,CAAC,wBAAwB;QACtC,IAAI,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE;YACzB,MAAM,UAAU,GAAe,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC;YACtD,MAAM,iBAAiB,GAAuB,EAAE,CAAC;YACjD,MAAM,UAAU,CAAC,eAAe,CAAC,iBAAiB,CAAC,CAAC;YAEpD,MAAM,iBAAO,CAAC,iCAAiC,CAC7C,IAAI,CAAC,QAAQ,EACb,OAAO,EACP,KAAK,IAAI,EAAE,CAAC,MAAM,UAAU,CAAC,YAAY,EAAE,CAC5C,CAAC;SACH;IACH,CAAC;IAES,KAAK,CAAC,aAAa;QAC3B,MAAM,UAAU,GAAe,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC;QACtD,MAAM,iBAAiB,mCAClB,uBAAU,CAAC,gCAAgC,CAAC,IAAI,CAAC,wBAAwB,CAAC,KAC7E,SAAS,EAAE,IAAI,CAAC,UAAU,CAAC,KAAK,EAChC,SAAS,EAAE,KAAK,GACjB,CAAC;QACF,MAAM,UAAU,CAAC,eAAe,CAAC,iBAAiB,CAAC,CAAC;QACpD,MAAM,UAAU,CAAC,YAAY,EAAE,CAAC;IAClC,CAAC;IAES,KAAK,CAAC,iBAAiB;QAC/B,IAAI,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE;YACzB,MAAM,IAAI,OAAO,CAAC,GAAG,EAAE;gBACrB,uCAAuC;YACzC,CAAC,CAAC,CAAC;SACJ;IACH,CAAC;CACF;AA1ED,kCA0EC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport { CommandLineFlagParameter, ICommandLineActionOptions } from '@rushstack/ts-command-line';\n\nimport { HeftActionBase, IHeftActionBaseOptions } from './HeftActionBase';\nimport { CleanStage, ICleanStageOptions } from '../../stages/CleanStage';\nimport { Logging } from '../../utilities/Logging';\nimport { BuildStage, IBuildStageOptions, IBuildStageStandardParameters } from '../../stages/BuildStage';\n\nexport class BuildAction extends HeftActionBase {\n  protected _watchFlag!: CommandLineFlagParameter;\n  protected _productionFlag!: CommandLineFlagParameter;\n  protected _liteFlag!: CommandLineFlagParameter;\n  private _buildStandardParameters!: IBuildStageStandardParameters;\n  private _cleanFlag!: CommandLineFlagParameter;\n\n  public constructor(\n    heftActionOptions: IHeftActionBaseOptions,\n    commandLineActionOptions: ICommandLineActionOptions = {\n      actionName: 'build',\n      summary: 'Build the project.',\n      documentation: ''\n    }\n  ) {\n    super(commandLineActionOptions, heftActionOptions);\n  }\n\n  public onDefineParameters(): void {\n    super.onDefineParameters();\n\n    this._buildStandardParameters = BuildStage.defineStageStandardParameters(this);\n    this._productionFlag = this._buildStandardParameters.productionFlag;\n    this._liteFlag = this._buildStandardParameters.liteFlag;\n\n    this._watchFlag = this.defineFlagParameter({\n      parameterLongName: '--watch',\n      parameterShortName: '-w',\n      description: 'If provided, run tests in watch mode.'\n    });\n\n    this._cleanFlag = this.defineFlagParameter({\n      parameterLongName: '--clean',\n      description: 'If specified, clean the package before building.'\n    });\n  }\n\n  protected async actionExecuteAsync(): Promise<void> {\n    await this.runCleanIfRequestedAsync();\n    await this.runBuildAsync();\n  }\n\n  protected async runCleanIfRequestedAsync(): Promise<void> {\n    if (this._cleanFlag.value) {\n      const cleanStage: CleanStage = this.stages.cleanStage;\n      const cleanStageOptions: ICleanStageOptions = {};\n      await cleanStage.initializeAsync(cleanStageOptions);\n\n      await Logging.runFunctionWithLoggingBoundsAsync(\n        this.terminal,\n        'Clean',\n        async () => await cleanStage.executeAsync()\n      );\n    }\n  }\n\n  protected async runBuildAsync(): Promise<void> {\n    const buildStage: BuildStage = this.stages.buildStage;\n    const buildStageOptions: IBuildStageOptions = {\n      ...BuildStage.getOptionsFromStandardParameters(this._buildStandardParameters),\n      watchMode: this._watchFlag.value,\n      serveMode: false\n    };\n    await buildStage.initializeAsync(buildStageOptions);\n    await buildStage.executeAsync();\n  }\n\n  protected async afterExecuteAsync(): Promise<void> {\n    if (this._watchFlag.value) {\n      await new Promise(() => {\n        /* never continue if in --watch mode */\n      });\n    }\n  }\n}\n"]}