{"version":3,"file":"ApiExtractorRunner.js","sourceRoot":"","sources":["../../../src/plugins/ApiExtractorPlugin/ApiExtractorRunner.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as semver from 'semver';\nimport * as path from 'path';\nimport { ITerminal, Path } from '@rushstack/node-core-library';\nimport type * as TApiExtractor from '@microsoft/api-extractor';\n\nimport {\n  ISubprocessRunnerBaseConfiguration,\n  SubprocessRunnerBase\n} from '../../utilities/subprocess/SubprocessRunnerBase';\nimport { IScopedLogger } from '../../pluginFramework/logging/ScopedLogger';\n\nexport interface IApiExtractorRunnerConfiguration extends ISubprocessRunnerBaseConfiguration {\n  /**\n   * The path to the Extractor's config file (\"api-extractor.json\")\n   *\n   * For example, /home/username/code/repo/project/config/api-extractor.json\n   */\n  apiExtractorJsonFilePath: string;\n\n  /**\n   * The path to the @microsoft/api-extractor package\n   *\n   * For example, /home/username/code/repo/project/node_modules/@microsoft/api-extractor\n   */\n  apiExtractorPackagePath: string;\n\n  /**\n   * The path to the typescript package\n   *\n   * For example, /home/username/code/repo/project/node_modules/typescript\n   */\n  typescriptPackagePath: string | undefined;\n\n  /**\n   * If set to true, run API Extractor in production mode\n   */\n  production: boolean;\n}\n\nexport class ApiExtractorRunner extends SubprocessRunnerBase<IApiExtractorRunnerConfiguration> {\n  private _scopedLogger!: IScopedLogger;\n  private _terminal!: ITerminal;\n\n  public get filename(): string {\n    return __filename;\n  }\n\n  public async invokeAsync(): Promise<void> {\n    this._scopedLogger = await this.requestScopedLoggerAsync('api-extractor');\n    this._terminal = this._scopedLogger.terminal;\n\n    const apiExtractor: typeof TApiExtractor = require(this._configuration.apiExtractorPackagePath);\n\n    this._scopedLogger.terminal.writeLine(`Using API Extractor version ${apiExtractor.Extractor.version}`);\n\n    const apiExtractorVersion: semver.SemVer | null = semver.parse(apiExtractor.Extractor.version);\n    if (\n      !apiExtractorVersion ||\n      apiExtractorVersion.major < 7 ||\n      (apiExtractorVersion.major === 7 && apiExtractorVersion.minor < 10)\n    ) {\n      this._scopedLogger.emitWarning(new Error(`Heft requires API Extractor version 7.10.0 or newer`));\n    }\n\n    const configObjectFullPath: string = this._configuration.apiExtractorJsonFilePath;\n    const configObject: TApiExtractor.IConfigFile =\n      apiExtractor.ExtractorConfig.loadFile(configObjectFullPath);\n\n    const extractorConfig: TApiExtractor.ExtractorConfig = apiExtractor.ExtractorConfig.prepare({\n      configObject,\n      configObjectFullPath,\n      packageJsonFullPath: path.join(this._configuration.buildFolder, 'package.json'),\n      projectFolderLookupToken: this._configuration.buildFolder\n    });\n\n    const extractorOptions: TApiExtractor.IExtractorInvokeOptions = {\n      localBuild: !this._configuration.production,\n      typescriptCompilerFolder: this._configuration.typescriptPackagePath,\n      messageCallback: (message: TApiExtractor.ExtractorMessage) => {\n        switch (message.logLevel) {\n          case apiExtractor.ExtractorLogLevel.Error: {\n            let logMessage: string;\n            if (message.sourceFilePath) {\n              const filePathForLog: string = Path.isUnderOrEqual(\n                message.sourceFilePath,\n                this._configuration.buildFolder\n              )\n                ? path.relative(this._configuration.buildFolder, message.sourceFilePath)\n                : message.sourceFilePath;\n              logMessage =\n                `${filePathForLog}:${message.sourceFileLine}:${message.sourceFileColumn} - ` +\n                `(${message.category}) ${message.text}`;\n            } else {\n              logMessage = message.text;\n            }\n\n            this._scopedLogger.emitError(new Error(logMessage));\n            break;\n          }\n\n          case apiExtractor.ExtractorLogLevel.Warning: {\n            let logMessage: string;\n            if (message.sourceFilePath) {\n              const filePathForLog: string = Path.isUnderOrEqual(\n                message.sourceFilePath,\n                this._configuration.buildFolder\n              )\n                ? path.relative(this._configuration.buildFolder, message.sourceFilePath)\n                : message.sourceFilePath;\n              logMessage =\n                `${filePathForLog}:${message.sourceFileLine}:${message.sourceFileColumn} - ` +\n                `(${message.messageId}) ${message.text}`;\n            } else {\n              logMessage = message.text;\n            }\n\n            this._scopedLogger.emitWarning(new Error(logMessage));\n            break;\n          }\n\n          case apiExtractor.ExtractorLogLevel.Verbose: {\n            this._terminal.writeVerboseLine(message.text);\n            break;\n          }\n\n          case apiExtractor.ExtractorLogLevel.Info: {\n            this._terminal.writeLine(message.text);\n            break;\n          }\n\n          case apiExtractor.ExtractorLogLevel.None: {\n            // Ignore messages with ExtractorLogLevel.None\n            break;\n          }\n\n          default:\n            this._scopedLogger.emitError(\n              new Error(`Unexpected API Extractor log level: ${message.logLevel}`)\n            );\n        }\n\n        message.handled = true;\n      }\n    };\n\n    const apiExtractorResult: TApiExtractor.ExtractorResult = apiExtractor.Extractor.invoke(\n      extractorConfig,\n      extractorOptions\n    );\n\n    const { errorCount, warningCount } = apiExtractorResult;\n    if (errorCount > 0) {\n      this._terminal.writeErrorLine(\n        `API Extractor completed with ${errorCount} error${errorCount > 1 ? 's' : ''}`\n      );\n    } else if (warningCount > 0) {\n      this._terminal.writeWarningLine(\n        `API Extractor completed with ${warningCount} warning${warningCount > 1 ? 's' : ''}`\n      );\n    }\n\n    if (!apiExtractorResult.succeeded) {\n      throw new Error('API Extractor failed.');\n    }\n\n    if (apiExtractorResult.apiReportChanged && this._configuration.production) {\n      throw new Error('API Report changed.');\n    }\n  }\n}\n"]}