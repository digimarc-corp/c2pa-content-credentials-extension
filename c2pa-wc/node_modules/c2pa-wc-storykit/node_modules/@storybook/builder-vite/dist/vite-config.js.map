{"version":3,"file":"vite-config.js","sourceRoot":"","sources":["../vite-config.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport fs from 'fs';\nimport { Plugin } from 'vite';\nimport { TypescriptConfig } from '@storybook/core-common';\nimport viteReact from '@vitejs/plugin-react';\n\nimport { allowedEnvPrefix as envPrefix } from './envs';\nimport { codeGeneratorPlugin } from './code-generator-plugin';\nimport { injectExportOrderPlugin } from './inject-export-order-plugin';\nimport { mdxPlugin } from './plugins/mdx-plugin';\nimport { noFouc } from './plugins/no-fouc';\nimport { sourceLoaderPlugin } from './source-loader-plugin';\n\nimport type { UserConfig } from 'vite';\nimport type { ExtendedOptions } from './types';\n\nexport type PluginConfigType = 'build' | 'development';\n\nexport function readPackageJson(): Record<string, any> | false {\n  const packageJsonPath = path.resolve('package.json');\n  if (!fs.existsSync(packageJsonPath)) {\n    return false;\n  }\n\n  const jsonContent = fs.readFileSync(packageJsonPath, 'utf8');\n  return JSON.parse(jsonContent);\n}\n\n// Vite config that is common to development and production mode\nexport async function commonConfig(\n  options: ExtendedOptions,\n  _type: PluginConfigType\n): Promise<UserConfig & { configFile: false; root: string }> {\n  const { framework } = options;\n\n  return {\n    configFile: false,\n    root: path.resolve(options.configDir, '..'),\n    cacheDir: 'node_modules/.vite-storybook',\n    envPrefix,\n    define: {},\n    resolve:\n      framework === 'vue3'\n        ? {\n            alias: {\n              vue: 'vue/dist/vue.esm-bundler.js',\n            },\n          }\n        : {},\n    plugins: await pluginConfig(options, _type),\n  };\n}\n\nexport async function pluginConfig(options: ExtendedOptions, _type: PluginConfigType) {\n  const { framework, presets } = options;\n  const svelteOptions: Record<string, any> = await presets.apply('svelteOptions', {}, options);\n\n  const plugins = [\n    codeGeneratorPlugin(options),\n    sourceLoaderPlugin(options),\n    mdxPlugin(options),\n    noFouc(),\n    injectExportOrderPlugin,\n    // We need the react plugin here to support MDX.\n    viteReact({\n      // Do not treat story files as HMR boundaries, storybook itself needs to handle them.\n      exclude: [/\\.stories\\.([tj])sx?$/, /node_modules/].concat(framework === 'react' ? [] : [/\\.([tj])sx?$/]),\n    }),\n    {\n      name: 'vite-plugin-storybook-allow',\n      enforce: 'post',\n      config(config) {\n        // if there is no allow list then Vite allows anything in the root directory\n        // if there is an allow list then Vite allows anything in the listed directories\n        // add the .storybook directory only if there's an allow list so that we don't end up\n        // disallowing the root directory unless it's already disallowed\n        if (config?.server?.fs?.allow) {\n          config.server.fs.allow.push('.storybook');\n        }\n      },\n    },\n  ] as Plugin[];\n  if (framework === 'vue' || framework === 'vue3') {\n    try {\n      const vuePlugin = require('@vitejs/plugin-vue');\n      plugins.push(vuePlugin());\n      const { vueDocgen } = await import('./plugins/vue-docgen');\n      plugins.push(vueDocgen());\n    } catch (err) {\n      if ((err as NodeJS.ErrnoException).code === 'MODULE_NOT_FOUND') {\n        throw new Error(\n          '@storybook/builder-vite requires @vitejs/plugin-vue to be installed ' +\n            'when using @storybook/vue or @storybook/vue3.' +\n            '  Please install it and start storybook again.'\n        );\n      }\n      throw err;\n    }\n  }\n  if (framework === 'svelte') {\n    try {\n      const sveltePlugin = require('@sveltejs/vite-plugin-svelte').svelte;\n\n      // We need to create two separate svelte plugins, one for stories, and one for other svelte files\n      // because stories.svelte files cannot be hot-module-reloaded.\n      // Suggested in: https://github.com/sveltejs/vite-plugin-svelte/issues/321#issuecomment-1113205509\n\n      // First, create an array containing user exclude patterns, to combine with ours.\n      const userExclude = Array.isArray(svelteOptions?.exclude)\n        ? svelteOptions?.exclude\n        : svelteOptions?.exclude\n        ? [svelteOptions?.exclude]\n        : [];\n\n      // These are the svelte stories we need to exclude from HMR\n      const storyPatterns = ['**/*.story.svelte', '**/*.stories.svelte'];\n      // Non-story svelte files\n      // Starting in 1.0.0-next.42, svelte.config.js is included by default.\n      // We disable that, but allow it to be overridden in svelteOptions\n      plugins.push(sveltePlugin({ ...svelteOptions, exclude: [...userExclude, ...storyPatterns] }));\n      // Svelte stories without HMR\n      const storySveltePlugin = sveltePlugin({\n        ...svelteOptions,\n        exclude: userExclude,\n        include: storyPatterns,\n        hot: false,\n      });\n      plugins.push({\n        // Starting in 1.0.0-next.43, the plugin function returns an array of plugins.  We only want the first one here.\n        ...(Array.isArray(storySveltePlugin) ? storySveltePlugin[0] : storySveltePlugin),\n        name: 'vite-plugin-svelte-stories',\n      });\n    } catch (err) {\n      if ((err as NodeJS.ErrnoException).code === 'MODULE_NOT_FOUND') {\n        throw new Error(\n          '@storybook/builder-vite requires @sveltejs/vite-plugin-svelte to be installed' +\n            ' when using @storybook/svelte.' +\n            '  Please install it and start storybook again.'\n        );\n      }\n      throw err;\n    }\n\n    const { loadSvelteConfig } = require('@sveltejs/vite-plugin-svelte');\n    const config = { ...loadSvelteConfig(), ...svelteOptions };\n\n    try {\n      const csfPlugin = require('./svelte/csf-plugin').default;\n      plugins.push(csfPlugin(config));\n    } catch (err) {\n      // Not all projects use `.stories.svelte` for stories, and by default 6.5+ does not auto-install @storybook/addon-svelte-csf.\n      // If it's any other kind of error, re-throw.\n      if ((err as NodeJS.ErrnoException).code !== 'MODULE_NOT_FOUND') {\n        throw err;\n      }\n    }\n\n    const { svelteDocgen } = await import('./plugins/svelte-docgen');\n    plugins.push(svelteDocgen(config));\n  }\n\n  if (framework === 'preact') {\n    plugins.push(require('@preact/preset-vite').default());\n  }\n\n  if (framework === 'react') {\n    const { reactDocgen: reactDocgenOption, reactDocgenTypescriptOptions } = await presets.apply(\n      'typescript',\n      {} as TypescriptConfig\n    );\n\n    if (reactDocgenOption === 'react-docgen-typescript') {\n      plugins.push(\n        require('@joshwooding/vite-plugin-react-docgen-typescript')({\n          ...reactDocgenTypescriptOptions,\n          // We *need* this set so that RDT returns default values in the same format as react-docgen\n          savePropValueAsString: true,\n        })\n      );\n    }\n\n    // Add react-docgen so long as the option is not false\n    if (typeof reactDocgenOption === 'string') {\n      const { reactDocgen } = await import('./plugins/react-docgen');\n      // Needs to run before the react plugin, so add to the front\n      plugins.unshift(\n        // If react-docgen is specified, use it for everything, otherwise only use it for non-typescript files\n        reactDocgen({ include: reactDocgenOption === 'react-docgen' ? /\\.(mjs|tsx?|jsx?)$/ : /\\.(mjs|jsx?)$/ })\n      );\n    }\n  }\n\n  if (framework === 'glimmerx') {\n    const plugin = require('vite-plugin-glimmerx/index.cjs');\n    plugins.push(plugin.default());\n  }\n\n  return plugins;\n}\n"]}